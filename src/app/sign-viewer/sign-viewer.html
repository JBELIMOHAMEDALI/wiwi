<div class="top-white-band"></div>

<div class="viewer-container">

    <!-- SUCCESS SCREEN -->
    <div class="success-screen" *ngIf="signedSuccess">
        <div class="success-card">
            <div class="success-icon">✅</div>
            <h2 class="success-title">Document signé avec succès</h2>
            <p class="success-msg">
                Votre signature a bien été enregistrée.<br/>
                Vous pouvez fermer cette fenêtre.
            </p>
        </div>
    </div>

    <!-- PDF PAGES -->
    <div class="pages-wrapper" *ngIf="!signedSuccess">
        <div class="page-container" *ngFor="let p of pdfPages">
            <img [src]="p.img" class="pdf-page" />
            <div class="page-number-outside">
                {{ p.pageNumber }} / {{ p.totalPages }}
            </div>
        </div>
    </div>

    <!-- SIGNATURE PANEL -->
    <div class="signature-overlay" *ngIf="pdfPages.length > 0 && !signedSuccess">

        <div class="collapsed-signature">
            <input type="checkbox" [(ngModel)]="termsAccepted" />
            <label>
                Je reconnais avoir lu le document et j'accepte les termes
            </label>
        </div>

        <div class="signature-expanded" *ngIf="termsAccepted">

            <div style="margin-left: 30%;margin-right: 30%;">
                <label class="label-cert">Sélectionnez le type de certificat</label>
                <select [(ngModel)]="selectedCert" (change)="onCertChange()" class="ngsign-select">
                    <option value="sscd">Signature avec SSCD</option>
                    <option value="digigo">DigiGo</option>
                </select>
            </div>

            <div class="info-sscd" *ngIf="selectedCert === 'digigo'">
                Liste des certificats détectés sur ce poste
            </div>

            <div *ngFor="let cert of certificates; let i = index" class="cert-box">

                <div class="cert-header">
                    <div>
                        <div class="cert-owner">{{ cert.alias }}</div>
                        <div class="cert-issued">
                            Émis par : <strong>{{ getIssuerCN(cert.issuer) }}</strong>
                        </div>
                        <a class="cert-toggle" (click)="expandedCertIndex = expandedCertIndex === i ? null : i">
                            {{ expandedCertIndex === i ? 'Moins de détails' : 'Plus de détails' }}
                        </a>
                    </div>
                    <span class="caret" [class.open]="expandedCertIndex === i"
                        (click)="expandedCertIndex = expandedCertIndex === i ? null : i">
                        ▲
                    </span>
                </div>

                <div class="cert-details" *ngIf="expandedCertIndex === i">

                    <div class="detail-row">
                        <div class="detail-label">Nom usuel</div>
                        <div class="detail-value mono">{{ cert.subject }}</div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Nom unique de l'émetteur</div>
                        <div class="detail-value mono">
                            C=TN, O=AGENCE NATIONALE DE CERTIFICATION ÉLECTRONIQUE,
                            {{ cert.issuer }}
                        </div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Utilisations</div>
                        <div class="detail-value">Signature électronique</div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Date de début</div>
                        <div class="detail-value">
                            {{ cert.validFrom | date:'dd MMMM yyyy à HH:mm':'':'fr' }}
                        </div>
                    </div>

                    <div class="detail-row">
                        <div class="detail-label">Date d'expiration</div>
                        <div class="detail-value">
                            {{ cert.validUntil | date:'dd MMMM yyyy à HH:mm':'':'fr' }}
                        </div>
                    </div>

                </div>

                <div class="btn-sign-wrapper">
                    <button class="btn-sign" (click)="signWithCert(cert)">
                        Signer avec ce certificat
                    </button>
                </div>

            </div>

        </div>
    </div>
</div>

<div class="bottom-white-band"></div>